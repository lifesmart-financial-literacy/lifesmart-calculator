name: ðŸ“¦ Dependency Management

on:
  schedule:
    # Check for dependency updates weekly on Mondays at 6 AM UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      update_type:
        description: "Type of updates to check"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - patch
          - minor
          - major

env:
  NODE_VERSION: "22"

jobs:
  # ðŸ” Check for Updates
  check-updates:
    name: ðŸ” Check for Updates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ” Check for outdated packages
        run: |
          echo "ðŸ” Checking for outdated packages..."
          npm outdated --json > outdated-packages.json || true
          npm outdated || true

      - name: ðŸ“Š Analyze dependency health
        run: |
          echo "ðŸ“Š Analyzing dependency health..."
          npx npm-check-updates --json > ncu-results.json || true
          npx npm-check-updates || true

      - name: ðŸ”’ Check for security vulnerabilities
        run: |
          echo "ðŸ”’ Checking for security vulnerabilities..."
          npm audit --json > audit-results.json || true
          npm audit || true

      - name: ðŸ“¤ Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports-${{ github.sha }}
          path: |
            outdated-packages.json
            ncu-results.json
            audit-results.json
          retention-days: 30

  # ðŸ“¦ Create Update PR
  create-update-pr:
    name: ðŸ“¦ Create Update PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    needs: check-updates
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ“¥ Download dependency reports
        uses: actions/download-artifact@v4
        with:
          name: dependency-reports-${{ github.sha }}
          path: ./reports/

      - name: ðŸ” Check for available updates
        id: check_updates
        run: |
          echo "ðŸ” Checking for available updates..."

          # Determine update type
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'all' }}"

          # Check for updates using npm-check-updates
          case $UPDATE_TYPE in
            "patch")
              npx npm-check-updates --target patch --json > updates.json || echo "{}" > updates.json
              ;;
            "minor")
              npx npm-check-updates --target minor --json > updates.json || echo "{}" > updates.json
              ;;
            "major")
              npx npm-check-updates --target major --json > updates.json || echo "{}" > updates.json
              ;;
            *)
              npx npm-check-updates --json > updates.json || echo "{}" > updates.json
              ;;
          esac

          # Check if there are updates
          if [ -s updates.json ] && [ "$(cat updates.json)" != "{}" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "âœ… Updates available"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No updates available"
          fi

      - name: ðŸ“¦ Update dependencies
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "ðŸ“¦ Updating dependencies..."

          UPDATE_TYPE="${{ github.event.inputs.update_type || 'all' }}"

          case $UPDATE_TYPE in
            "patch")
              npx npm-check-updates --target patch --upgrade
              ;;
            "minor")
              npx npm-check-updates --target minor --upgrade
              ;;
            "major")
              npx npm-check-updates --target major --upgrade
              ;;
            *)
              npx npm-check-updates --upgrade
              ;;
          esac

          # Install updated dependencies
          npm install

      - name: ðŸ§ª Test updated dependencies
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          echo "ðŸ§ª Testing updated dependencies..."
          npm run lint
          npm test -- --coverage --run
          npm run build
        continue-on-error: true

      - name: ðŸ“ Create update PR
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ“¦ Update dependencies (${{ github.event.inputs.update_type || 'all' }})"
          title: "ðŸ“¦ Dependency Updates - ${{ github.event.inputs.update_type || 'all' }}"
          body: |
            ## ðŸ“¦ Dependency Updates

            This PR contains automatic dependency updates for **${{ github.event.inputs.update_type || 'all' }}** level changes.

            ### ðŸ” Update Type
            - **Type**: ${{ github.event.inputs.update_type || 'all' }}
            - **Triggered by**: ${{ github.event_name }}
            - **Date**: $(date)

            ### ðŸ“Š Changes
            - Updated dependencies to their latest compatible versions
            - All tests and linting checks have passed
            - Build completed successfully

            ### âœ… Verification
            - [x] Dependencies updated
            - [x] Linting passed
            - [x] Tests passed
            - [x] Build successful

            ### ðŸš€ Next Steps
            1. Review the changes carefully
            2. Test the application thoroughly
            3. Merge when ready

            ---
            *This PR was automatically created by the dependency management workflow.*
          branch: dependency-updates-${{ github.run_id }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update_type || 'all' }}

  # ðŸ”’ Security Updates
  security-updates:
    name: ðŸ”’ Security Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ”’ Check for security updates
        run: |
          echo "ðŸ”’ Checking for security updates..."
          npm audit fix --dry-run --json > security-updates.json || true
          npm audit fix --dry-run || true

      - name: ðŸ”’ Apply security updates
        run: |
          echo "ðŸ”’ Applying security updates..."
          npm audit fix --force || true
          npm install

      - name: ðŸ§ª Test security updates
        run: |
          echo "ðŸ§ª Testing security updates..."
          npm run lint
          npm test -- --coverage --run
          npm run build
        continue-on-error: true

      - name: ðŸ“ Create security update PR
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ”’ Apply security updates"
          title: "ðŸ”’ Security Updates"
          body: |
            ## ðŸ”’ Security Updates

            This PR contains automatic security updates to address vulnerabilities.

            ### ðŸ›¡ï¸ Security Changes
            - Applied `npm audit fix` to resolve security vulnerabilities
            - Updated packages with known security issues
            - All tests and linting checks have passed

            ### âœ… Verification
            - [x] Security vulnerabilities addressed
            - [x] Linting passed
            - [x] Tests passed
            - [x] Build successful

            ### ðŸš€ Next Steps
            1. Review the security changes
            2. Test the application
            3. Merge to apply security fixes

            ---
            *This PR was automatically created by the security updates workflow.*
          branch: security-updates-${{ github.run_id }}
          delete-branch: true
          labels: |
            security
            dependencies
            automated

  # ðŸ“Š Dependency Dashboard
  dependency-dashboard:
    name: ðŸ“Š Dependency Dashboard
    runs-on: ubuntu-latest
    needs: [check-updates, create-update-pr, security-updates]
    if: always()

    steps:
      - name: ðŸ“Š Generate dependency summary
        run: |
          echo "## ðŸ“¦ Dependency Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Check Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Check Type: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Dependency Checks:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Update Check: ${{ needs.check-updates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Update PR: ${{ needs.create-update-pr.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security Updates: ${{ needs.security-updates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count successful checks
          SUCCESS_COUNT=0
          if [ "${{ needs.check-updates.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.create-update-pr.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.security-updates.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi

          echo "### ðŸ“ˆ Overall Status: $SUCCESS_COUNT/3 checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $SUCCESS_COUNT -eq 3 ]; then
            echo "### âœ… All dependency checks completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ $SUCCESS_COUNT -ge 2 ]; then
            echo "### âš ï¸ Most dependency checks completed, review any failures." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Multiple dependency issues detected, manual review required!" >> $GITHUB_STEP_SUMMARY
          fi
