name: ðŸš€ Comprehensive CI/CD Pipeline

on:
  push:
    branches: [main, develop, "feature/*", "hotfix/*"]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: "22"
  CACHE_VERSION: v1

jobs:
  # ðŸ” Code Quality & Testing
  quality-checks:
    name: ðŸ” Code Quality & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm list --depth=0

      - name: ðŸ” Run ESLint
        run: |
          echo "ðŸ” Running ESLint..."
          npm run lint -- --max-warnings 0
        continue-on-error: false

      - name: ðŸŽ¨ Run Prettier check
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,md,json}"
        continue-on-error: false

      - name: ðŸ§ª Run tests with coverage
        run: |
          echo "ðŸ§ª Running tests..."
          npm test -- --coverage --watchAll=false --passWithNoTests
        env:
          CI: true

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: ðŸ—ï¸ Build project
        run: |
          echo "ðŸ—ï¸ Building project..."
          npm run build
          echo "âœ… Build completed successfully"

      - name: ðŸ“ Bundle size analysis
        run: |
          echo "ðŸ“ Analyzing bundle size..."
          npx bundlesize
        continue-on-error: true

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: build/
          retention-days: 30
          compression-level: 6

  # ðŸ”’ Security Scanning
  security-scan:
    name: ðŸ”’ Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ” Run npm audit
        run: |
          echo "ðŸ” Running security audit..."
          npm audit --audit-level moderate --production
        continue-on-error: true

      - name: ðŸ”’ Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

      - name: ðŸ›¡ï¸ Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:javascript"

  # ðŸš€ Performance Testing
  performance-tests:
    name: ðŸš€ Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quality-checks

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ“Š Run Lighthouse CI
        run: |
          echo "ðŸ“Š Running Lighthouse performance tests..."
          npx @lhci/cli@0.12.x autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        continue-on-error: true

      - name: ðŸ“ˆ Bundle analyzer
        run: |
          echo "ðŸ“ˆ Analyzing bundle composition..."
          npx webpack-bundle-analyzer build/static/js/*.js --mode static --report build/bundle-report.html
        continue-on-error: true

  # ðŸ§ª E2E Testing
  e2e-tests:
    name: ðŸ§ª E2E Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quality-checks

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸš€ Start application
        run: |
          echo "ðŸš€ Starting application..."
          npx serve -s build -l 3000 &
          sleep 10
          curl -f http://localhost:3000 || exit 1
        env:
          CI: true

      - name: ðŸ§ª Run Playwright tests
        run: |
          echo "ðŸ§ª Running E2E tests..."
          npx playwright install --with-deps
          npx playwright test
        continue-on-error: true

  # ðŸ“± Cross-browser Testing
  cross-browser:
    name: ðŸ“± Cross-browser Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality-checks
    strategy:
      matrix:
        browser: [chrome, firefox, safari]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ§ª Run cross-browser tests
        run: |
          echo "ðŸ§ª Testing on ${{ matrix.browser }}..."
          npx playwright test --project=${{ matrix.browser }}
        continue-on-error: true

  # ðŸš€ Deployment
  deploy:
    name: ðŸš€ Deploy to ${{ github.event.inputs.environment || 'staging' }}
    runs-on: ubuntu-latest
    needs: [quality-checks, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files-${{ github.sha }}
          path: build/

      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: "--prod"
        continue-on-error: true

      - name: ðŸš€ Deploy to Netlify
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: "./build"
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        continue-on-error: true

      - name: ðŸ“¢ Notify deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "ðŸ“¦ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Author: ${{ github.actor }}"

  # ðŸ“Š Performance Monitoring
  performance-monitor:
    name: ðŸ“Š Performance Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Run Web Vitals monitoring
        run: |
          echo "ðŸ“Š Monitoring Web Vitals..."
          # Add your performance monitoring script here
          echo "âœ… Performance monitoring completed"
        continue-on-error: true

  # ðŸŽ¯ Summary
  ci-summary:
    name: ðŸŽ¯ CI Summary
    runs-on: ubuntu-latest
    needs: [quality-checks, security-scan, performance-tests, e2e-tests]
    if: always()

    steps:
      - name: ðŸ“Š Generate CI summary
        run: |
          echo "## ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Code Quality & Testing: ${{ needs.quality-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security Scanning: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Performance Testing: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª E2E Testing: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Pipeline Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ• Completed at: $(date)" >> $GITHUB_STEP_SUMMARY
